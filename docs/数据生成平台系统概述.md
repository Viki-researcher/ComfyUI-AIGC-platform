# 菲特数据生成平台 — 系统概述

> 本文是平台的核心文档，涵盖架构、全部功能模块、数据模型及 API 端点一览。  
> 详细配置请参考 [03_配置说明](03_配置说明_前端后端ComfyUI.md)，部署请参考 [部署指南](deployment-guide.md)。

---

## 1. 平台简介

菲特数据生成平台是一套面向 AI 数据生产与智能辅助的一体化系统。平台以 ComfyUI 为核心生成引擎，结合大语言模型（LLM）对话、RAG 文档问答、Agent 工具调用、工作流编辑器等能力，为用户提供从项目创建、数据生成、日志统计到智能分析的完整闭环。

**核心能力**：
- 项目管理与生成配额控制
- ComfyUI 按需实例化与心跳管理
- AI 多模型对话（支持 OpenAI 兼容协议）
- RAG 文档上传、分块、嵌入与检索增强生成
- Agent Function Calling 与内置工具集
- Skills 预配置技能系统
- 多模态（图片输入 / 视觉模型）
- ComfyUI 工作流模板 & AI 工作流生成
- Token 用量追踪与管理员仪表板
- Docker Compose 一键部署

---

## 2. 系统架构

### 2.1 架构图

```
┌───────────────────────────────────────────────────────────────┐
│                     前端 (Vue 3 + Vite)                        │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐ ┌──────┐ │
│  │ AI 对话   │ │ 工作流    │ │ 数据统计  │ │ 监控   │ │ 用量  │ │
│  │ (SSE)    │ │ 编辑器    │ │ 仪表板    │ │        │ │ 面板  │ │
│  └────┬─────┘ └────┬─────┘ └────┬─────┘ └───┬────┘ └──┬───┘ │
│       └─────────────┴────────────┴───────────┴─────────┘     │
│                          │  REST API + SSE                    │
└──────────────────────────┼────────────────────────────────────┘
                           │
┌──────────────────────────┼────────────────────────────────────┐
│                     后端 (FastAPI)                              │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐         │
│  │ Chat API │ │Workflow  │ │ Agent    │ │ RAG      │         │
│  │ (SSE)    │ │ API      │ │ Executor │ │ Service  │         │
│  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘         │
│       │             │            │             │               │
│  ┌────┴─────────────┴────────────┴─────────────┴───────────┐  │
│  │            LLM Client (OpenAI SDK)                      │  │
│  │         多提供商支持 (OpenAI-compatible 协议)              │  │
│  └─────────────────────────────────────────────────────────┘  │
│       │                                                       │
│  ┌────┴────────────────────────────────────────────────────┐  │
│  │           Tortoise ORM (PostgreSQL / SQLite)             │  │
│  └──────────────────────────────────────────────────────────┘  │
└───────────────────────────┬───────────────────────────────────┘
                            │
┌───────────────────────────┼───────────────────────────────────┐
│                     ComfyUI Engine                             │
│  ┌──────────────────────────────────────────────────────┐     │
│  │  ComfyUI 实例 (按需启动，每用户/项目独立端口)           │     │
│  └──────────────────────────────────────────────────────┘     │
└───────────────────────────────────────────────────────────────┘
```

### 2.2 技术栈

| 层级     | 技术                                                              |
|----------|------------------------------------------------------------------|
| 前端     | Vue 3 + TypeScript + Vite + Element Plus（Art Design Pro 模板）    |
| 后端     | Python 3.11 + FastAPI + Tortoise ORM + Aerich                     |
| 数据库   | PostgreSQL 14+（生产）/ SQLite（快速开发）                          |
| LLM 集成 | OpenAI SDK（兼容 OpenAI / 通义千问 / Ollama 等 OpenAI-compatible） |
| 生成引擎 | ComfyUI（Python 3.12 独立环境）                                    |
| 部署     | Docker Compose（postgres + backend + frontend）                   |
| 鉴权     | JWT + RBAC（角色-菜单-API 三级权限）                                |

### 2.3 服务组件

| 服务       | 目录                       | 默认端口 | 说明                           |
|-----------|----------------------------|---------|-------------------------------|
| 前端       | `art-design-pro/`          | 3006    | Vite DevServer / Nginx         |
| 后端       | `vue-fastapi-admin-main/`  | 9999    | FastAPI 异步服务                |
| ComfyUI   | `ComfyUI-master-fitow/`   | 8200+   | 按需启动，端口池 8200-8299       |
| PostgreSQL | —                          | 5432    | 异步连接 (asyncpg)             |

---

## 3. 核心功能模块

### 3.1 用户认证与权限

- **注册**：`POST /api/auth/register` — 用户名 / 邮箱 / 密码，Argon2 哈希存储
- **登录**：`POST /api/auth/login` — 返回 JWT Token，前端存储并在后续请求携带 `Authorization` 头
- **RBAC**：User ↔ Role ↔ Menu / API 多对多关系；接口级权限由 `DependPermission` 依赖注入校验
- **资源级权限**：项目操作 / ComfyUI 启动仅限项目所有者（owner check + 403）

### 3.2 项目管理（含目标生成数量）

| 操作       | 接口                                    | 说明                                      |
|-----------|----------------------------------------|------------------------------------------|
| 新建项目   | `POST /api/projects`                   | 字段：name、code、note、target_count        |
| 项目列表   | `GET /api/projects`                    | 支持按名称/项目号筛选，返回 generated_count    |
| 更新项目   | `PUT /api/projects/{id}`               | 仅 owner 可操作                             |
| 删除项目   | `DELETE /api/projects/{id}`            | 同时清理关联的 ComfyUI 服务记录               |

- **target_count**：项目目标生成数量，0 = 不限制。当 `generated_count >= target_count` 时，后端拒绝启动 ComfyUI 并提示已达上限。

### 3.3 ComfyUI 数据生成引擎

通过 `POST /api/projects/{id}/open_comfy` 触发：

1. 查询该项目是否已有在线服务 → 有则复用
2. 无则从端口池分配端口，启动 ComfyUI 子进程
3. 等待健康检查通过（`GET /system_stats`，超时可配置）
4. 返回 `comfy_url` 给前端跳转

**心跳机制**：后端定时检查所有服务 (`heartbeat_loop`)，更新 online/offline 状态。  
**日志采集**：轮询 ComfyUI `/history` 或通过回调节点写入 `generation_logs`。

详见 [11_ComfyUI_启动逻辑说明](11_ComfyUI_启动逻辑说明.md)。

### 3.4 AI 智能对话

平台集成了完整的 LLM 对话系统，基于 SSE 流式响应。详细配置见 [llm-chat-config.md](llm-chat-config.md)。

#### 3.4.1 多模型支持

- 兼容所有 OpenAI-compatible API（OpenAI / 通义千问 / Ollama / vLLM 等）
- `LLM_PROVIDERS_JSON` 支持配置多个提供商，前端实时切换
- 每个会话可独立指定 provider + model

#### 3.4.2 Markdown 渲染与代码高亮

- AI 回复支持完整 Markdown 语法：标题、列表、表格、引用、代码块
- 代码块使用 `highlight.js` 语法高亮（100+ 语言）
- `DOMPurify` XSS 安全过滤

#### 3.4.3 多模态（图片输入/输出）

- 用户可上传图片或粘贴剪贴板图片
- 后端将图片 base64 编码为 OpenAI 视觉格式
- 支持 GPT-4o、Qwen-VL 等视觉模型
- AI 回复中的图片 URL 自动渲染为内嵌图片

#### 3.4.4 Agent 工具调用

基于 Function Calling 的 Agent 框架，LLM 自动判断是否需要调用工具：

```
用户消息 → LLM → (tool_call) → 执行工具 → (tool_result) → LLM → 最终回复
```

**内置工具集**：

| 工具名                    | 说明                     |
|--------------------------|-------------------------|
| `list_projects`          | 查询项目列表              |
| `query_generation_logs`  | 查询生成日志              |
| `get_server_stats`       | 获取服务器资源状态         |
| `analyze_anomalies`      | 检测生成失败率异常         |
| `export_report_excel`    | 导出 Excel 统计报表       |

SSE 事件类型：`token`、`tool_call`、`tool_result`、`done`、`error`。

详见 [feature-modules.md](feature-modules.md)。

#### 3.4.5 Skills 技能系统

预配置的 LLM 提示词模板，用户一键调用：

| 技能 ID            | 名称              | 分类    |
|-------------------|-------------------|---------|
| `translate`       | 智能翻译           | 语言    |
| `code_review`     | 代码审查           | 开发    |
| `summarize`       | 文本摘要           | 写作    |
| `data_analysis`   | 数据分析助手        | 数据    |
| `workflow_helper`  | ComfyUI 工作流助手 | AI 生成 |

自定义技能方法见 [skills-config.md](skills-config.md)。

#### 3.4.6 RAG 文档问答

- 支持上传 txt / md / pdf / docx / csv / xlsx 及图片文件
- 自动文本提取 → 分块 → Embedding 嵌入 → 余弦相似度检索
- 检索到的相关片段注入 LLM 上下文，生成增强回复
- 配置项：`RAG_ENABLED`、`RAG_CHUNK_SIZE`、`RAG_TOP_K` 等

#### 3.4.7 引用追踪

- RAG 检索结果通过 SSE `rag_citations` 事件发送至前端
- 每条引用包含：文档名称、片段内容、匹配分数
- 前端在 AI 回复下方显示"参考来源"卡片

### 3.5 工作流编辑器

在平台内嵌入简化版 ComfyUI 工作流编辑器，支持：

- 加载预置模板（txt2img、img2img）
- JSON 编辑器直接编辑工作流
- 参数面板自动提取关键参数并双向同步
- **AI 生成**：自然语言描述 → 生成工作流 JSON
- **提交执行**：将工作流发送到运行中的 ComfyUI 实例

前端路由：`/platform/workflow`  
详见 [feature-modules.md](feature-modules.md)。

### 3.6 数据统计与日志

- **日志写入**：ComfyUI 生成完成后通过轮询或回调写入 `generation_logs`
- **统计聚合**：`GET /api/stats` 支持按天 / 项目 / 用户维度聚合
- **明细查询**：`GET /api/logs` 支持多条件筛选
- **Excel 导出**：`GET /api/export` 返回 Excel 文件流

前端提供趋势折线图 + 数据表格 + 导出按钮。

### 3.7 服务器监控

- `GET /api/server/stats` — 实时 CPU / 内存 / SWAP / 磁盘使用率
- `GET /api/server/stats/history` — 历史监控数据
- 前端定时轮询，仪表盘只读展示（无开关机按钮）

### 3.8 用量与计费

自动记录每次 LLM 调用的 Token 消耗（prompt_tokens / completion_tokens）。

| 接口                     | 说明                          |
|-------------------------|------------------------------|
| `GET /api/chat/usage`    | 当前用户用量汇总               |
| `GET /api/chat/usage/all`| 所有用户用量（仅管理员）         |

按模型分组统计，支持日期范围筛选。

---

## 4. 数据模型概览

### 4.1 基础模型（框架内置）

| 模型    | 表名   | 说明                          |
|---------|--------|------------------------------|
| User    | `user` | 用户信息、密码哈希、超级用户标识  |
| Role    | `role` | 角色定义，多对多关联 User/Menu/API |

### 4.2 平台业务模型

| 模型             | 表名                | 关键字段                                              |
|-----------------|--------------------|----------------------------------------------------|
| Project         | `projects`         | name, code, note, owner_user_id, target_count       |
| ComfyUIService  | `comfyui_services` | user_id, project_id, port, status, pid, comfy_url    |
| GenerationLog   | `generation_logs`  | user_id, project_id, timestamp, status, prompt_id    |

### 4.3 AI 对话模型

| 模型            | 表名               | 关键字段                                              |
|----------------|--------------------|----------------------------------------------------|
| ChatSession    | `chat_sessions`    | user_id, title, model_provider, model_name           |
| ChatMessage    | `chat_messages`    | session_id, role, content, token_count               |
| ChatDocument   | `chat_documents`   | user_id, filename, file_path, file_type, status      |
| DocumentChunk  | `document_chunks`  | document_id, content, chunk_index, embedding         |
| TokenUsage     | `token_usage`      | user_id, provider, model, prompt_tokens, completion_tokens |

所有模型继承 `BaseModel + TimestampMixin`，自带 `id`、`created_at`、`updated_at` 字段。

---

## 5. API 端点概览

所有接口统一前缀 `/api`，响应格式 `{ code, msg, data }`。

### 5.1 认证

| 方法   | 路径                   | 说明       |
|--------|----------------------|-----------|
| POST   | `/api/auth/login`    | 用户登录    |
| POST   | `/api/auth/register` | 用户注册    |

### 5.2 用户与角色

| 方法 | 路径                     | 说明                  |
|------|-------------------------|-----------------------|
| GET  | `/api/user/info`        | 当前用户信息            |
| GET  | `/api/user/list`        | 用户列表（分页）         |
| GET  | `/api/role/list`        | 角色列表（分页）         |

### 5.3 系统

| 方法 | 路径                     | 说明                           |
|------|-------------------------|-------------------------------|
| GET  | `/api/v3/system/menus`  | 菜单列表（兼容 art-design-pro）  |

### 5.4 项目管理

| 方法   | 路径                                    | 说明                    |
|--------|----------------------------------------|------------------------|
| POST   | `/api/projects`                        | 新建项目                 |
| GET    | `/api/projects`                        | 项目列表                 |
| PUT    | `/api/projects/{id}`                   | 更新项目                 |
| DELETE | `/api/projects/{id}`                   | 删除项目                 |
| POST   | `/api/projects/{id}/open_comfy`        | 启动/打开 ComfyUI        |

### 5.5 生成日志

| 方法 | 路径            | 说明             |
|------|----------------|-----------------|
| POST | `/api/logs`    | 写入生成日志      |
| GET  | `/api/logs`    | 查询生成日志      |

### 5.6 数据统计

| 方法 | 路径             | 说明                     |
|------|-----------------|-------------------------|
| GET  | `/api/stats`    | 统计聚合（按天/项目/用户）  |
| GET  | `/api/export`   | 导出统计（Excel）          |

### 5.7 服务器监控

| 方法 | 路径                          | 说明             |
|------|------------------------------|-----------------|
| GET  | `/api/server/stats`          | 实时资源监控      |
| GET  | `/api/server/stats/history`  | 历史监控数据      |

### 5.8 AI 对话

| 方法   | 路径                                      | 说明                       |
|--------|------------------------------------------|---------------------------|
| GET    | `/api/chat/providers`                    | 获取可用 LLM 提供商列表      |
| POST   | `/api/chat/sessions`                     | 新建对话会话                 |
| GET    | `/api/chat/sessions`                     | 获取会话列表                 |
| GET    | `/api/chat/sessions/{id}`                | 获取会话详情                 |
| PUT    | `/api/chat/sessions/{id}`                | 更新会话（切换模型等）        |
| DELETE | `/api/chat/sessions/{id}`                | 删除会话                    |
| GET    | `/api/chat/sessions/{id}/messages`       | 获取消息历史                 |
| POST   | `/api/chat/sessions/{id}/chat`           | 发送消息（SSE 流式响应）      |
| POST   | `/api/chat/images/upload`                | 上传图片（多模态）            |
| GET    | `/api/chat/images/{filename}`            | 获取图片                    |
| POST   | `/api/chat/documents/upload`             | 上传文档（RAG）              |
| GET    | `/api/chat/documents`                    | 获取文档列表                 |
| DELETE | `/api/chat/documents/{id}`               | 删除文档                    |
| GET    | `/api/chat/documents/{id}/preview`       | 预览文档内容                 |
| GET    | `/api/chat/usage`                        | 当前用户 Token 用量          |
| GET    | `/api/chat/usage/all`                    | 所有用户 Token 用量（管理员）  |
| GET    | `/api/chat/reports/{filename}`           | 下载报告文件                 |
| GET    | `/api/chat/skills`                       | 获取可用技能列表              |
| POST   | `/api/chat/skills/{id}/run`              | 执行技能（SSE 流式响应）      |

### 5.9 工作流

| 方法 | 路径                         | 说明                    |
|------|-----------------------------|-----------------------|
| GET  | `/api/workflow/templates`   | 获取工作流模板列表        |
| POST | `/api/workflow/generate`    | AI 生成工作流            |
| POST | `/api/workflow/submit`      | 提交工作流到 ComfyUI     |
| PUT  | `/api/workflow/modify`      | AI 修改工作流参数        |

---

## 6. 部署方式

### 6.1 Docker Compose（推荐）

```bash
cp .env.example .env          # 编辑填入 LLM_API_KEY 等配置
docker compose up -d           # 启动 postgres + backend + frontend
# 访问 http://localhost:3006   默认账号: admin / 123456
```

详见 [deployment-guide.md](deployment-guide.md)。

### 6.2 手动部署

```bash
# 后端
cd vue-fastapi-admin-main
python3 -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
python run.py

# 前端
cd art-design-pro
pnpm install && pnpm dev
```

详见 [deployment-guide.md](deployment-guide.md)。

### 6.3 一键脚本（开发联调）

```bash
cd docs
cp .env.platform.example .env.platform   # 修改路径/端口
chmod +x scripts/*.sh
./scripts/start_all.sh
```

详见 [10_平台启动与停止](10_平台启动与停止.md)。

---

## 7. 配置参考

| 配置域      | 文档                                                              |
|------------|------------------------------------------------------------------|
| 前端/后端   | [03_配置说明](03_配置说明_前端后端ComfyUI.md)                        |
| LLM/RAG    | [llm-chat-config.md](llm-chat-config.md)                        |
| Skills     | [skills-config.md](skills-config.md)                             |
| 环境变量汇总 | [deployment-guide.md #环境变量参考](deployment-guide.md)            |

---

## 8. 目录结构

```
$PROJECT_ROOT/
├── art-design-pro/                  # 前端 (Vue 3 + Vite)
│   ├── src/
│   │   ├── api/                     # API 请求封装
│   │   ├── views/platform/          # 平台业务页面
│   │   └── components/core/layouts/ # 核心组件（含 AI 聊天窗口）
│   └── ...
├── vue-fastapi-admin-main/          # 后端 (FastAPI)
│   ├── app/
│   │   ├── api/compat/              # 兼容前端契约的 API 路由
│   │   ├── models/                  # 数据模型 (Tortoise ORM)
│   │   │   ├── platform.py          # Project / ComfyUIService / GenerationLog
│   │   │   └── chat.py             # ChatSession / ChatMessage / ChatDocument / ...
│   │   ├── services/                # 业务服务层
│   │   │   ├── llm_client.py        # LLM 统一调用
│   │   │   ├── rag_service.py       # RAG Pipeline
│   │   │   ├── agent_executor.py    # Agent 执行器
│   │   │   ├── agent_tools.py       # 工具注册中心
│   │   │   ├── skills_config.py     # 技能定义
│   │   │   └── comfyui_manager.py   # ComfyUI 进程管理
│   │   └── settings/config.py       # 配置（BaseSettings）
│   └── ...
├── ComfyUI-master-fitow/           # ComfyUI 生成引擎
├── docs/                           # 文档目录
│   ├── scripts/                    # 一键启停脚本
│   └── .env.platform.example       # 统一环境变量模板
├── docker-compose.yml              # Docker 生产部署
└── docker-compose.dev.yml          # Docker 开发模式
```

---

*文档版本：v3.0*  
*更新日期：2026-02-27*
