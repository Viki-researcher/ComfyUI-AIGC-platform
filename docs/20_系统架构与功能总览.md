# 数据生成平台 — 系统架构与功能总览

> **本文档为平台功能的权威说明**，涵盖所有已实现模块。
> 最后更新：合并 AI 对话/Agent/RAG/工作流编辑器 后的完整版本。

---

## 1. 系统架构

### 1.1 技术栈

| 层 | 技术 | 说明 |
|----|------|------|
| 前端 | Vue 3 + TypeScript + Vite + Element Plus + TailwindCSS | 端口 3006 |
| 后端 | FastAPI + Tortoise ORM + Aerich + Uvicorn | 端口 9999 |
| 数据库 | PostgreSQL 16（生产） / SQLite（开发可选） | 异步 asyncpg |
| AI 生成引擎 | ComfyUI（端口池 8200-8299） | CPU/GPU 自适应 |
| 数据标注 | SAM3 Annotation Tool（Gradio，端口池 7860-7899） | YOLO/COCO 导出 |
| AI 对话 | 多 LLM 提供商（OpenAI/DeepSeek/通义/Ollama） | 流式 SSE |
| Agent | Function Calling 工具执行框架 | 配额管理 |
| RAG | 文档检索增强生成 | 向量/关键词混合 |
| 缓存/队列 | Redis（预留） | 端口 6379 |

### 1.2 架构图

```
用户浏览器
    │
    ▼
┌──────────────────┐     ┌──────────────────────────┐
│  前端 (Vite:3006) │────▶│     后端 (FastAPI:9999)    │
│  Vue3 + Element   │     │  ┌───────┬───────┬──────┐ │
│  ArtChatWindow    │◀────│  │LLM    │Agent  │RAG   │ │
└──────────────────┘ SSE  │  │Client │Exec   │Svc   │ │
                          │  └───────┴───────┴──────┘ │
                          └──────┬──────┬──────┬──────┘
                                 │      │      │
                    ┌────────────┼──────┼──────┘
                    ▼            ▼      ▼
              ┌──────────┐ ┌────────┐ ┌────────┐
              │PostgreSQL │ │ComfyUI │ │ SAM3   │
              │ (:5432)   │ │(:8200+)│ │(:7860+)│
              └──────────┘ └────────┘ └────────┘
```

---

## 2. 功能模块一览

| # | 模块 | 路由 | 来源 |
|---|------|------|------|
| 1 | 仪表盘（首页） | `/platform/dashboard` | 本分支 |
| 2 | 个人工作台（项目管理） | `/platform/workbench` | 双方+合并 |
| 3 | 智能 Prompt 助手 | `/platform/prompt` | 本分支 |
| 4 | 数据统计看板 | `/platform/stats` | 双方+合并 |
| 5 | 生成日志 | `/platform/logs` | 双方+合并 |
| 6 | 服务器监控 | `/platform/monitor` | 双方 |
| 7 | 工作流编辑器 | `/platform/workflow` | e8f2 分支 |
| 8 | 用量与计费 | `/platform/usage` | e8f2 分支 |
| 9 | AI 对话（聊天窗口） | 全局 ArtChatWindow | e8f2 分支 |
| 10 | SAM3 数据标注 | 通过项目卡片启动 | 本分支 |
| 11 | 数据集导出 | API: `/api/dataset/export` | 本分支 |

---

## 3. 仪表盘（首页）

平台默认首页，展示全局概览：今日生成量、活跃项目数、平台用户数、生成成功率、在线服务面板。

`GET /api/dashboard`

---

## 4. 个人工作台（项目管理）

### 4.1 项目卡片

| 元素 | 说明 |
|------|------|
| 环形进度条 | `generated_count / target_count`，颜色随进度变化 |
| 服务状态灯 | ComfyUI 和标注工具的在线状态（🟢/🔴/⚪） |
| 已达目标提示 | 达到上限后禁用「数据生成」按钮 |
| 操作按钮 | 数据生成 / 数据标注 / 编辑 / 删除 |

### 4.2 目标数量控制

达到 `target_count` 后后端返回 400，前端禁用按钮。编辑项目修改上限后可解除。

### 4.3 ComfyUI 数据生成

后端按需启动 ComfyUI 实例，端口池 8200-8299，心跳 30s，自动采集生成日志。

### 4.4 SAM3 数据标注

后端按需启动 Gradio 标注工具，端口池 7860-7899。支持 YOLO 和 COCO 格式导出。标注操作不计入数据统计。

---

## 5. 智能 Prompt 助手

输入中文/英文需求描述，选择 8 种风格模板之一，自动生成正面/反面提示词。

`POST /api/prompt/generate` · `GET /api/prompt/styles`

---

## 6. AI 对话系统（ArtChatWindow）

### 6.1 功能

- 多 LLM 提供商切换（OpenAI/DeepSeek/通义/Ollama/自定义）
- 流式 SSE 渲染（打字机效果）
- Markdown 渲染 + 代码高亮
- 图片上传与多模态对话
- 聊天历史管理

### 6.2 Agent 模式

- Function Calling 工具执行框架
- 内置工具：平台数据查询、ComfyUI 操作等
- 配额管理（按用户限制调用次数）

### 6.3 RAG 检索增强

- 文档上传（PDF/MD/TXT/CSV/Excel）
- 向量检索 + 关键词混合搜索
- 引用追踪（回答标注来源文档）
- ComfyUI 文档自动索引

### 6.4 Skills 技能系统

后端配置驱动的技能定义，支持自定义 Prompt 模板和工具组合。

配置参见：`docs/skills-config.md` · `docs/llm-chat-config.md`

---

## 7. 数据统计看板

日期区间筛选 + 每日趋势图 + 按项目/用户多线对比曲线 + 统计表格。

`GET /api/stats` · `GET /api/stats/trend` · `GET /api/export`

---

## 8. 生成日志

用户/项目/状态/日期 下拉筛选 + 分页表格 + Excel 导出（JWT blob 下载）。

`GET /api/logs` · `GET /api/logs/export`

---

## 9. 工作流编辑器

ComfyUI 工作流的 CRUD 管理和 Agent 辅助编辑。

`GET /api/workflow/templates` · `POST /api/workflow/generate`

---

## 10. 用量与计费

AI 对话调用量统计柱状图，按时间/模型维度展示。

---

## 11. 数据集导出

平台侧：`GET /api/dataset/export?project_id=1&format=yolo|coco`（ZIP 下载）
标注工具侧：SAM3 内置 YOLO/COCO 导出

---

## 12. 服务器监控

只读面板：CPU / 内存 / SWAP / 磁盘 / GPU。`GET /api/server/stats`

---

## 13. 数据模型

| 表名 | 说明 |
|------|------|
| `projects` | 项目（含 target_count） |
| `comfyui_services` | ComfyUI 服务实例 |
| `annotation_services` | 标注服务实例 |
| `generation_logs` | 生成日志 |
| `chat_sessions` / `chat_messages` | 对话历史 |
| `user` / `role` / `menu` / `api` | 系统管理（框架内置） |

---

## 14. 部署方式

- **开发环境**：参见 `10_平台启动与停止.md`
- **Docker Compose**：参见 `30_Docker_Compose部署.md` + `docker-compose.yml`
- **LLM 配置**：参见 `docs/llm-chat-config.md`
- **Skills 配置**：参见 `docs/skills-config.md`
