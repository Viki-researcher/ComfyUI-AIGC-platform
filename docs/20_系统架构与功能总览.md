# 数据生成平台 — 系统架构与功能总览

> **本文档为平台功能的权威说明**，涵盖所有已实现模块。
> 合并了原 `数据生成平台系统概述.md`（基础需求描述）与 `05_功能模块文档.md`（新增功能）。

---

## 1. 系统架构

### 1.1 技术栈

| 层 | 技术 | 说明 |
|----|------|------|
| 前端 | Vue 3 + TypeScript + Vite + Element Plus + TailwindCSS | 端口 3006 |
| 后端 | FastAPI + Tortoise ORM + Aerich + Uvicorn | 端口 9999 |
| 数据库 | PostgreSQL 16（生产） / SQLite（开发可选） | 异步连接 asyncpg |
| AI 生成引擎 | ComfyUI（按项目按需启动，端口池 8200-8299） | CPU/GPU 自适应 |
| 数据标注 | SAM3 Annotation Tool（Gradio，端口池 7860-7899） | 支持 YOLO/COCO 导出 |
| 缓存/队列 | Redis（预留） | 端口 6379 |

### 1.2 架构图

```
用户浏览器
    │
    ▼
┌──────────────────┐     ┌──────────────────┐
│  前端 (Vite:3006) │────▶│  后端 (FastAPI:9999)│
│  Vue3 + Element   │     │  Tortoise ORM     │
└──────────────────┘     └────────┬─────────┘
                                  │
                    ┌─────────────┼─────────────┐
                    ▼             ▼              ▼
              ┌──────────┐ ┌──────────┐  ┌──────────┐
              │PostgreSQL │ │ ComfyUI  │  │  SAM3    │
              │ (:5432)   │ │(:8200+)  │  │ (:7860+) │
              └──────────┘ └──────────┘  └──────────┘
```

### 1.3 核心流程

```
用户 → 前端 → POST /api/projects/{id}/open_comfy → 后端启动 ComfyUI 实例 → 返回 URL → 新标签页打开
用户 → 前端 → POST /api/projects/{id}/open_annotation → 后端启动标注工具 → 返回 URL → 新标签页打开
ComfyUI 生成完成 → 后端轮询 /history 或回调 → 写入 generation_logs → 前端统计看板展示
```

---

## 2. 用户管理

### 2.1 注册与登录

- 注册：`POST /api/auth/register`，入参 `{ username, email, password }`
- 登录：`POST /api/auth/login`，入参 `{ userName, password }`，返回 JWT Token
- 用户信息：`GET /api/user/info`，返回 `{ buttons, roles, userId, userName, email }`

### 2.2 鉴权机制

- 前端：所有请求通过统一 HTTP 封装（`src/utils/http/index.ts`）自动注入 `Authorization` 头
- 后端：`DependPermission` 依赖注入校验 JWT + RBAC 角色权限
- 资源级校验：`open_comfy`/`open_annotation` 等接口额外验证项目所有者

### 2.3 角色与权限

| 角色 | 权限范围 |
|------|----------|
| 管理员 | 全部菜单 + 全部 API |
| 普通用户 | 数据生成平台菜单 + 基础模块/项目/日志/统计/监控 API |

---

## 3. 仪表盘（首页）

**路由**：`/platform/dashboard`（平台默认首页）

### 3.1 核心指标卡片

| 指标 | 数据来源 | 说明 |
|------|----------|------|
| 今日生成量 | `GenerationLog` 当天记录数 | 对比昨日数量 |
| 活跃项目数 | `Project` 总数 | — |
| 平台用户数 | `User` 总数 | — |
| 生成成功率 | 成功数 / 总数 × 100% | 全局百分比 |

### 3.2 在线服务面板

显示当前在线的 ComfyUI 实例数和标注工具实例数（绿色=有在线实例，灰色=全部离线）。

### 3.3 API

`GET /api/dashboard` → 返回全部概览数据。

---

## 4. 个人工作台（项目管理）

**路由**：`/platform/workbench`

### 4.1 项目卡片

每个项目以卡片形式展示，包含以下元素：

| 元素 | 说明 |
|------|------|
| 项目名称 + 项目号 | 卡片头部 |
| **环形进度条** | 显示 `generated_count / target_count`，颜色随进度变化（橙→蓝→绿） |
| **服务状态灯** | ComfyUI（🟢在线/🔴异常/⚪未启动）和标注工具状态 |
| 所有者 + 创建日期 | 基本信息 |
| 备注 | 仅在有内容时显示 |
| 已达目标提示 | `generated_count >= target_count` 时显示绿色提示 |
| 操作按钮 | 数据生成 / 数据标注 / 编辑 / 删除 |

### 4.2 目标数量控制

- 创建/编辑项目时可设置 `target_count`（目标生成数量），默认 1000
- 当成功生成数达到目标数量时：
  - 「数据生成」按钮自动**禁用**
  - 后端 `open_comfy` 接口返回 `400` 并提示
  - 用户可通过「编辑」按钮修改 `target_count` 后解除限制

### 4.3 数据生成（ComfyUI）

点击「数据生成」→ 后端启动 ComfyUI 实例 → 新标签页打开 ComfyUI 界面

- **权限**：仅项目所有者可操作
- **端口池**：8200-8299，自动选择空闲端口
- **心跳检测**：后端每 30 秒检查实例健康状态
- **生成日志采集**：后端轮询 ComfyUI `/history` 接口自动写入 `generation_logs`

### 4.4 数据标注（SAM3 Annotation Tool）

点击「数据标注」→ 后端启动 Gradio 标注工具 → 新标签页打开

- **权限**：仅项目所有者可操作
- **端口池**：7860-7899
- **导出格式**：支持 YOLO 和 COCO 两种格式导出
- **注意**：标注操作**不计入**数据统计

### 4.5 项目 CRUD API

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/projects` | 创建项目（含 `target_count`） |
| GET | `/api/projects` | 项目列表（含进度和状态） |
| PUT | `/api/projects/{id}` | 更新项目 |
| DELETE | `/api/projects/{id}` | 删除项目（同时清理服务） |
| POST | `/api/projects/{id}/open_comfy` | 启动 ComfyUI |
| POST | `/api/projects/{id}/open_annotation` | 启动标注工具 |

---

## 5. 智能 Prompt 助手

**路由**：`/platform/prompt`

### 5.1 功能

输入中文或英文需求描述，自动生成 ComfyUI 可用的正面/反面提示词。

### 5.2 内置风格模板（8种）

写实摄影 / 动漫风格 / 概念艺术 / 产品渲染 / 人像特写 / 场景建筑 / 科幻未来 / 水彩插画

### 5.3 输出

- **正面提示词**（Positive）：需求描述 + 风格后缀 + 质量增强词
- **反面提示词**（Negative）：通用排除词（低质量、变形等）
- **使用建议**：风格说明、ControlNet 建议等

### 5.4 API

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/prompt/generate` | 生成 Prompt |
| GET | `/api/prompt/styles` | 获取风格列表 |

---

## 6. 数据统计看板

**路由**：`/platform/stats`

### 6.1 图表

| 图表 | 说明 |
|------|------|
| 每日生成趋势 | 折线图，X轴=日期，Y轴=当日生成次数 |
| 按项目趋势曲线 | 多线对比，每个项目一条线 |
| 按用户趋势曲线 | 多线对比，每个用户一条线 |

### 6.2 日期区间筛选

页面顶部提供「开始日期」「结束日期」选择器 + 查询/重置按钮。

### 6.3 统计表格

按项目统计（项目名/次数）和按用户统计（用户名/次数）并排显示。

### 6.4 API

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/stats` | 聚合统计（维度：day/project/user） |
| GET | `/api/stats/trend` | 时序趋势（按项目/用户分组） |
| GET | `/api/export` | 导出统计 Excel |

---

## 7. 生成日志

**路由**：`/platform/logs`

### 7.1 筛选功能

| 筛选器 | 类型 |
|--------|------|
| 用户 | 下拉选择 |
| 项目 | 下拉选择 |
| 状态 | 下拉选择（成功/失败/未知） |
| 开始日期 | 日期选择 |
| 结束日期 | 日期选择 |

### 7.2 Excel 导出

点击「导出 Excel」按钮，使用 axios blob 下载（携带 JWT 认证），文件名自动包含时间戳。

### 7.3 API

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/logs` | 分页查询日志 |
| POST | `/api/logs` | 写入生成日志 |
| GET | `/api/logs/export` | 导出日志 Excel |

---

## 8. 数据集导出

### 8.1 平台侧导出

通过 `GET /api/dataset/export?project_id=1&format=yolo` 从平台导出项目的生成记录。

| 格式 | 输出 |
|------|------|
| YOLO | `data.yaml` + `labels/*.txt` + `metadata.json` |
| COCO | `annotations/instances_default.json` + `metadata.json` |

### 8.2 标注工具侧导出

SAM3 Annotation Tool 内置导出功能，支持 YOLO 和 COCO 两种格式：
- YOLO：标准 YOLOv5/v8 分割格式，含 `data.yaml` 和归一化多边形坐标
- COCO：标准 COCO JSON（images/annotations/categories），含 segmentation 多边形、bbox、area

---

## 9. 服务器监控

**路由**：`/platform/monitor`

只读监控面板，展示 CPU、内存、SWAP、磁盘使用率和 GPU 信息。

`GET /api/server/stats` → 实时系统指标。

---

## 10. 数据模型

### 10.1 数据库表

| 表名 | 主要字段 | 说明 |
|------|----------|------|
| `user` | id, username, email, password_hash, is_superuser | 用户（框架内置） |
| `role` | id, name, desc | 角色（框架内置） |
| `menu` | id, name, path, component, parent_id, remark | 菜单（框架内置） |
| `api` | id, method, path, tags | API权限（框架内置） |
| `projects` | id, name, code, note, owner_user_id, **target_count**, created_at | 项目 |
| `comfyui_services` | id, user_id, project_id, port, status, comfy_url, pid, last_heartbeat | ComfyUI 服务 |
| `annotation_services` | id, user_id, project_id, port, status, annotation_url, pid | 标注服务 |
| `generation_logs` | id, user_id, project_id, timestamp, status, prompt_id, details | 生成日志 |

### 10.2 关键约束

- `projects.code` 唯一
- `(user_id, project_id)` 在 comfyui_services 和 annotation_services 上唯一
- `(project_id, prompt_id)` 在 generation_logs 上唯一

---

## 11. 前端页面路由

| 路径 | 页面 | 组件 |
|------|------|------|
| `/platform/dashboard` | 仪表盘 | `/platform/dashboard` |
| `/platform/workbench` | 个人工作台 | `/platform/workbench` |
| `/platform/prompt` | Prompt 助手 | `/platform/prompt` |
| `/platform/stats` | 数据统计 | `/platform/stats` |
| `/platform/logs` | 生成日志 | `/platform/logs` |
| `/platform/monitor` | 服务器监控 | `/platform/monitor` |

---

## 12. 部署方式

### 12.1 开发环境（手动启动）

参见 [10_平台启动与停止.md](10_平台启动与停止.md) 和 [03_配置说明](03_配置说明_前端后端ComfyUI.md)。

### 12.2 容器化部署（Docker Compose）

参见 [30_Docker_Compose部署.md](30_Docker_Compose部署.md)。

```bash
docker compose up -d   # 一键启动
docker compose down    # 停止
```
