# 数据生成平台 — 功能模块文档

## 目录

1. [项目卡片优化](#1-项目卡片优化)
2. [仪表盘首页](#2-仪表盘首页)
3. [数据集导出](#3-数据集导出)
4. [智能 Prompt 助手](#4-智能-prompt-助手)
5. [Docker Compose 容器化部署](#5-docker-compose-容器化部署)

---

## 1. 项目卡片优化

### 1.1 进度指示器

每个项目卡片显示一个环形进度条，直观展示当前生成进度：

- **数据源**：`generated_count`（成功的生成日志数）/ `target_count`（项目设定的目标数量）
- **颜色规则**：
  - `< 60%`：橙色（警告，进度较慢）
  - `60% ~ 99%`：蓝色（正常推进中）
  - `100%`：绿色（已完成）
- **创建/编辑项目时**可设置 `目标生成数量`，默认 1000

### 1.2 服务状态灯

每个项目卡片显示 ComfyUI 和标注工具的实时运行状态：

| 颜色 | 状态 | 说明 |
|------|------|------|
| 🟢 绿色（带发光） | `online` | 服务正在运行中 |
| 🔴 红色（带发光） | `offline` | 服务已异常/掉线 |
| ⚪ 灰色 | `stopped` | 服务未启动 |

### 1.3 API 变更

`GET /api/projects` 响应新增字段：

```json
{
  "target_count": 1000,
  "generated_count": 245,
  "comfy_status": "online",
  "annotation_status": "stopped"
}
```

`POST /api/projects` 和 `PUT /api/projects/{id}` 请求支持 `target_count` 参数。

---

## 2. 仪表盘首页

### 2.1 功能概述

新增「仪表盘」页面，作为平台首页，展示全局概览数据：

| 指标卡片 | 数据来源 | 说明 |
|----------|----------|------|
| 今日生成量 | `GenerationLog` 今日记录数 | 对比昨日数量 |
| 活跃项目数 | `Project` 总数 | 所有项目 |
| 平台用户数 | `User` 总数 | 所有注册用户 |
| 生成成功率 | 成功数 / 总数 × 100% | 全局成功率 |

### 2.2 在线服务面板

显示当前在线的 ComfyUI 和标注工具实例数量。

### 2.3 API

```
GET /api/dashboard
```

响应示例：

```json
{
  "today_count": 156,
  "yesterday_count": 203,
  "total_count": 1973,
  "success_count": 1580,
  "success_rate": 80.1,
  "active_projects": 5,
  "total_users": 4,
  "online_comfy": 1,
  "online_annotation": 0
}
```

---

## 3. 数据集导出

### 3.1 支持格式

| 格式 | 输出内容 | 适用场景 |
|------|----------|----------|
| **YOLO** | `data.yaml` + `labels/*.txt` | 目标检测（YOLOv5/v8） |
| **COCO** | `annotations/instances_default.json` | 通用目标检测/实例分割 |

### 3.2 导出流程

1. 在项目卡片或详情页选择导出格式
2. 后端查询该项目所有成功的生成记录
3. 按格式规范生成标注文件
4. 打包为 `.zip` 文件下载

### 3.3 API

```
GET /api/dataset/export?project_id=1&format=yolo
GET /api/dataset/export?project_id=1&format=coco
```

响应：`application/zip` 二进制流。

### 3.4 输出结构

**YOLO 格式：**

```
project_ALPHA-001_yolo_20260226.zip
├── data.yaml           # 数据集配置
├── labels/
│   ├── 000000.txt
│   ├── 000001.txt
│   └── ...
└── metadata.json       # 导出元数据
```

**COCO 格式：**

```
project_ALPHA-001_coco_20260226.zip
├── annotations/
│   └── instances_default.json
└── metadata.json
```

---

## 4. 智能 Prompt 助手

### 4.1 功能概述

提供基于模板的 Prompt 生成工具，帮助用户快速构建高质量的 ComfyUI 提示词。

### 4.2 风格模板

| 模板 | 描述 |
|------|------|
| 写实摄影 | 专业摄影、超真实、8K 分辨率 |
| 动漫风格 | 动漫画风、鲜艳色彩、赛璐珞着色 |
| 概念艺术 | 数字绘画、哑光绘画、电影构图 |
| 产品渲染 | 产品摄影、白色背景、商业品质 |
| 人像特写 | 人像摄影、浅景深、虚化效果 |
| 场景建筑 | 建筑可视化、光线渲染 |
| 科幻未来 | 赛博朋克、霓虹灯、体积雾 |
| 水彩插画 | 水彩画、柔和色调、手绘质感 |

### 4.3 使用流程

1. 输入需求描述（中文或英文）
2. 选择风格模板
3. 选择是否添加质量增强词
4. 点击「生成 Prompt」
5. 复制正面/反面提示词到 ComfyUI

### 4.4 API

```
POST /api/prompt/generate
{
  "description": "一只白色的猫坐在窗台上",
  "style": "写实摄影",
  "enhance": true
}

GET /api/prompt/styles
```

---

## 5. Docker Compose 容器化部署

### 5.1 服务架构

```
┌─────────────┐    ┌─────────────┐
│   Frontend   │───▶│   Backend   │
│  (Vite:3006) │    │ (FastAPI:   │
│              │    │  9999)      │
└─────────────┘    └──────┬──────┘
                          │
                   ┌──────┴──────┐
                   │             │
              ┌────▼────┐  ┌────▼────┐
              │PostgreSQL│  │  Redis  │
              │ (:5432)  │  │ (:6379) │
              └─────────┘  └─────────┘
```

### 5.2 快速启动

```bash
# 一键启动所有服务
docker compose up -d

# 查看服务状态
docker compose ps

# 查看日志
docker compose logs -f backend

# 停止所有服务
docker compose down
```

### 5.3 服务说明

| 服务 | 镜像 | 端口 | 说明 |
|------|------|------|------|
| `db` | postgres:16-alpine | 5432 | PostgreSQL 数据库 |
| `redis` | redis:7-alpine | 6379 | 缓存/队列（预留） |
| `backend` | 自定义 | 9999 | FastAPI 后端 |
| `frontend` | 自定义 | 3006 | Vue3 前端 |

### 5.4 数据持久化

- PostgreSQL 数据：`pgdata` volume
- 后端运行时文件：`backend_runtime` volume
- ComfyUI/标注工具：通过 bind mount 挂载宿主目录
