from __future__ import annotations

import json
import os
import zipfile
from datetime import datetime
from io import BytesIO
from pathlib import Path

from fastapi import APIRouter, Query
from fastapi.responses import StreamingResponse

from app.core.dependency import DependPermission
from app.models.platform import GenerationLog, Project
from app.schemas.base import Fail, Success

router = APIRouter(prefix="/dataset", tags=["数据集模块"])


@router.get("/export", summary="导出数据集(YOLO/COCO)", dependencies=[DependPermission])
async def export_dataset(
    project_id: int = Query(..., description="项目ID"),
    format: str = Query("yolo", description="导出格式: yolo / coco"),
):
    project = await Project.filter(id=project_id).first()
    if not project:
        return Fail(code=404, msg="项目不存在")

    logs = await GenerationLog.filter(project_id=project_id, status="成功").order_by("timestamp").all()
    if not logs:
        return Fail(code=400, msg="该项目暂无成功的生成记录")

    buf = BytesIO()
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"{project.code}_{format}_{timestamp}.zip"

    with zipfile.ZipFile(buf, "w", zipfile.ZIP_DEFLATED) as zf:
        if format == "coco":
            coco = _build_coco_structure(project, logs)
            zf.writestr("annotations/instances_default.json", json.dumps(coco, ensure_ascii=False, indent=2))
        else:
            data_yaml = _build_yolo_data_yaml(project)
            zf.writestr("data.yaml", data_yaml)
            for i, log in enumerate(logs):
                label_content = f"# Generated by {project.name}\n# prompt_id: {log.prompt_id}\n# timestamp: {log.timestamp}\n"
                zf.writestr(f"labels/{i:06d}.txt", label_content)

        meta = {
            "project": project.name,
            "code": project.code,
            "format": format,
            "total_samples": len(logs),
            "exported_at": timestamp,
        }
        zf.writestr("metadata.json", json.dumps(meta, ensure_ascii=False, indent=2))

    buf.seek(0)
    headers = {"Content-Disposition": f'attachment; filename="{filename}"'}
    return StreamingResponse(buf, headers=headers, media_type="application/zip")


def _build_yolo_data_yaml(project: Project) -> str:
    return f"""# YOLO Dataset Configuration
# Project: {project.name} ({project.code})
# Auto-generated by Data Generation Platform

path: .
train: images/train
val: images/val

names:
  0: object
"""


def _build_coco_structure(project: Project, logs) -> dict:
    images = []
    annotations = []
    for i, log in enumerate(logs):
        images.append({
            "id": i + 1,
            "file_name": f"{i:06d}.jpg",
            "width": 512,
            "height": 512,
        })

    return {
        "info": {
            "description": f"{project.name} - {project.code}",
            "version": "1.0",
            "year": datetime.now().year,
            "contributor": "Data Generation Platform",
        },
        "licenses": [],
        "images": images,
        "annotations": annotations,
        "categories": [{"id": 1, "name": "object", "supercategory": "none"}],
    }
